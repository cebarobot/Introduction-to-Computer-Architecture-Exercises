# 计算机体系结构基础 - 第 4 章作业

## 4.1
在观看网络视频时，网卡将接收到的网络包放到内存并通知处理器对视频数据流进行解码好发送给显示单元。

此时，处理器对该网络包的中断处理是否应分上下部？若是，应如何切分？

**解**

由于整个流程需要处理器处理大量数据，所需的时间长，应当分上下部处理。

上半部运行于中断上下文，负责清除中断状态，将对数据解码的处理方案通知到相应中断的进程。

下半部由专门的工作者进程处理，负责实际执行解码数据流的过程，可以进行休眠和阻塞。

## 4.2
（1）用 MIPS 汇编程序来举例并分析未同步的线程之间进行共享数据访问出错的情况。  
（2）用 LL/SC 指令改写你的程序，使它们的共享数据访问正确。

**解**

（1）考虑一个双线程程序，两个线程向一个数组中分别写入 100 ~ 1，过程中共用一个偏移量。两个程序代码相同，如下：
```plain
    li      $t1, 100
L:
    lw      $t0, 0($a0)
    addiu   $t0, 1
    sw      $t0, 0($a0)
    sw      $t1, 0($t0)
    addiu   $t1, -1
    bnez    $t1, LL
```

（2）修改后的程序如下：
```plain
    li      $t1, 100
L:
    ll      $t0, 0($a0)
    addiu   $t0, 1
    sc      $t0, 0($a0)
    beqz    $t0, L

    sw      $t1, 0($t0)
    addiu   $t1, -1
    bnez    $t1, L
```

## 4.3
（1）在你的机器上安装 MIPS 交叉编译器，通过编译-反汇编的方式提取函数调用的核心片段。  
（2）改变编译的优化选项，记录函数调用核心片段的变化，并分析不同优化选项的效果。

**解**

这里使用 `mips64el-linux-gcc` 作为交叉编译器。

（1）以下面的程序为例：
```c
int function_b(int a, int b) {
    return a + b;
}
void function_a() {
    int a = 10; 
    int b = 12;
    function_b(a, b);
}
```

在不添加编译优化选项的情况下，`function_a` 中调用 `function_b` 的核心片段如下：
```plain
move    a0,v1
move    a1,v0
ld      v0,-32664(gp)
move    t9,v0
jalr    t9
nop
```
`function_b` 中进入函数和退出函数的核心片段如下：
```plain
daddiu  sp,sp,-32
sd      s8,24(sp)
move    s8,sp
# do something
move    sp,s8
ld      s8,24(sp)
daddiu  sp,sp,32
jr      ra
nop
```

（2）
不开启编译优化时（即 `-O0`），汇编代码与上面所述相同。

在开启编译优化 `-O1` 时，由于上面的函数均不需要用栈，`function_a` 和 `function_b` 中有关函数调用的准备代码基本被全部优化掉了，只剩下一个用于返回的 `jr ra` 指令。

## 4.4
ABI 中会包含对结构体中各元素的对齐和摆放方式的定义。

（1）在你的机器上用 C 语言编写一段包含不同类型的结构体，并获得结构体总空间占用情况。  
（2）调整结构体元素顺序，推测并分析结构体对齐的方式。

**解**

（1）以下面的结构体实验：
```c
struct Test{
    char a;
    short b;
    int c;
    long d;
};
```
经过实验，其占用空间为 16 字节。

（2）调整顺序为：
```c
struct Test{
    char a;
    long d;
    short b;
    int c;
};
```
其占用空间为 24 字节。

调整顺序为：
```c
struct Test{
    char a;
    int c;
    long d;
    short b;
};
```
其占用空间仍为 24 字节。

调整为：
```c
struct Test{
    char a;
    short b;
    int c;
    int e;
};
```
其占用空间为 12 字节。

调整为：
```c
struct Test{
    char a;
    short b;
    int c;
    long f;
    int e;
};
```
其占用空间为 24 字节。

由此可以推测，结构体以其中包含的最长元素为单位对齐。例如，存在 `long` 时，以 8 字节对齐；不存在 `long` 但存在 `int` 时，以 4 字节对齐。

## 4.5
函数调用、系统调用和中断处理都需要上下文切换，请结合 MIPS O32 ABI 说明上述三种上下文切换时保留现场有什么不同（内容、位置）。

**解**

* 函数调用：需要保存寄存器中由被调用者保存的寄存器（`s0` ~ `s8` 以及 6 个浮点寄存器）和栈帧（`s8/fp`），保存位置在栈上。
* 系统调用：需要保存寄存器中由被调用者保存的寄存器（`s0` ~ `s8` 以及 6 个浮点寄存器），保存位置在内核栈上或 PCB 中。
* 中断处理：需要保存所有通用寄存器和部分控制寄存器的值，保存位置在内核栈上或 PCB 中。